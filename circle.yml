machine:
  node:
    version: 4.6.0
  services:
    - docker
  environment:
    PACTBROKERURL: 'http://54.197.31.162:80/'


test:
  override:
    - gem list | grep rake
    - npm run mocha
#    - npm run fitnesse
    - npm run pact
  post:
    - docker build -t $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/mapmaker:$CIRCLE_SHA1 .
    - docker run -d -p 3000:3000 --name mapmaker $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/mapmaker:$CIRCLE_SHA1; sleep 10
    #- hostport=$(docker inspect --format='{{(index (index .NetworkSettings.Ports "3000/tcp") 0).HostPort}}' mapmaker)
    - curl -H 'bugs:4' -H 'features:20' -sSf http://localhost:3000/api/mapmaker > /dev/null
    - docker stop pactbroker
    - docker rm pactbroker

deployment:
  prod:
    branch: master
    commands:
      - ./deploy.sh